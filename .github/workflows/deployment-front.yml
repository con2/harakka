name: Azure Static Web Apps CI/CD
permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      - name: Install common dependencies (common types folder)
        run: |
          cd common
          npm ci
      - name: Install front dependencies
        working-directory: ./frontend
        run: |
          rm -f package-lock.json
          npm install
      - name: Clean problematic symlinks (circular references)
        run: |
          find frontend/node_modules -type l -name "common" -delete
          find frontend/node_modules -type l -name "full-stack-booking-app" -delete
      - name: Create environment file
        run: |
          cd frontend
          echo "VITE_SUPABASE_URL=https://rcbddkhvysexkvgqpcud.supabase.co" > .env.production
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env.production
          echo "VITE_API_URL=https://booking-app-backend-duh9encbeme0awca.northeurope-01.azurewebsites.net" >> .env.production

        # Build the frontend
      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Check build file count
        run: |
          echo "Counting files in frontend/dist..."
          find frontend/dist -type f | wc -l
          echo "If this number is >4000, deployment will likely fail."

      - name: Prepare for deployment
        run: |
          cd frontend
           # Copy staticwebapp.config.json into dist if it's not already there
           if [ ! -f dist/staticwebapp.config.json ]; then
             cp staticwebapp.config.json dist/
           fi
           
           # Clean up the dist folder to ensure minimum files
           echo "=== Files in dist before cleanup ==="
           find dist -type f | sort
           
           # Double-check file count
           echo "Final file count before deployment:"
           find dist -type f | wc -l
           
           # Show size of distribution
           du -sh dist

      - name: Deploy to Azure Static Web Apps
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_GRASS_049DC8010 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
          # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
          app_location: "/frontend/dist" # App source code path
          api_location: "" # Api source code path - optional
          output_location: "" # Built app content directory - optional
          skip_app_build: true # Set to true to skip building the app - optional
          app_build_command: "echo 'Skipping build'"
          config_file_location: "/frontend"
          ###### End of Repository/Build Configurations ######
      - name: Verify Environment Variables
        run: |
          cd frontend
          echo "Checking environment variables for troubleshooting:"
          echo "VITE_SUPABASE_URL length: ${#VITE_SUPABASE_URL}"
          echo "VITE_SUPABASE_ANON_KEY available: $(if [ -n "$VITE_SUPABASE_ANON_KEY" ]; then echo "Yes"; else echo "No"; fi)"
          echo "VITE_API_URL available: $(if [ -n "$VITE_API_URL" ]; then echo "Yes"; else echo "No"; fi)"
        env:
          VITE_SUPABASE_URL: "https://rcbddkhvysexkvgqpcud.supabase.co" ###### hardcoded for debugging purposes ######
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_API_URL: https://booking-app-backend-duh9encbeme0awca.northeurope-01.azurewebsites.net

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_AGREEABLE_GRASS_049DC8010 }}
          action: "close"
          app_location: "/frontend/dist"
